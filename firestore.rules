rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Auth Helpers ---
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isPartner(resId) {
      return request.auth != null && request.auth.token.restaurantId == resId;
    }

    function isAnyPartner() {
      return request.auth != null && request.auth.token.restaurantId != null;
    }

    function isDeliveryBoy() {
      return request.auth != null && request.auth.token.deliveryBoy == true;
    }

    // --- Restaurants: public read, partners update own, admins full ---
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow update: if isPartner(restaurantId) || isAdmin();
      allow create, delete: if isAdmin();
    }

    // --- Site Content: public read (order settings, banners, grocery settings) ---
    match /site_content/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Laundry Slots: public read ---
    match /laundry_slots/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- General Settings: public read (campus config etc.) ---
    match /general_settings/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Orders: NO public read ---
    // Admins: full access
    // Partners: read + update orders containing their restaurantId
    // Delivery boys: read ready_for_delivery orders; claim by updating to picked_up
    // Public: create only
    match /orders/{orderId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
      allow read, update: if isAnyPartner()
        && request.auth.token.restaurantId in resource.data.restaurantIds;
      allow read: if isDeliveryBoy()
        && resource.data.status == "ready_for_delivery";
      allow update: if isDeliveryBoy()
        && resource.data.status == "ready_for_delivery"
        && request.resource.data.status == "picked_up"
        && request.resource.data.deliveryBoyUid == request.auth.uid;
    }

    // --- FCM Tokens: own user only ---
    match /fcm_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Catch-all: admin write only, no public read for unlisted collections ---
    match /{document=**} {
      allow write, read: if isAdmin();
    }
  }
}
